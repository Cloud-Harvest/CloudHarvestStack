services:
  harvest-agent:                    # Agent: Collects data and performs asynchronous tasks.
    image: "fionajuneleathers/cloud-harvest-agent:${HARVEST_AGENT_IMAGE_TAG:-latest}"   # The Docker image to use for this service
    depends_on:
      - harvest-api
    stop_signal: SIGINT             # Specifies the system call signal to be sent to the container to exit
    volumes:                        # Specifies the paths that should be mounted into the container
      - "~/.ssh:/root/.ssh"
      - "./app/agent/:/src/app/"
    working_dir: /src               # The working directory inside the container
    networks:                       # Specifies the networks the container should connect to
      - CloudHarvestStackNetwork
    environment:                     # Add environment variables
      HTTPS_PROXY: "${HTTPS_PROXY}"
      NO_PROXY: "${NO_PROXY}"

  harvest-api:                      # Api: provides interface for retrieving data and directing Agents to perform work.
    image: "fionajuneleathers/cloud-harvest-api:${HARVEST_API_IMAGE_TAG:-latest}"   # The Docker image to use for this service
    depends_on:
      - mongo
      - haproxy-tasks
    ports:                          # Maps the port inside the Docker container to the host
      - "8000:8000"
    stop_signal: SIGINT             # Specifies the system call signal to be sent to the container to exit
    volumes:                        # Specifies the paths that should be mounted into the container
      - "~/.ssh:/root/.ssh"
      - "./app/api/:/src/app/"
    working_dir: /src               # The working directory inside the container
    networks:                       # Specifies the networks the container should connect to
      - CloudHarvestStackNetwork
    environment:                     # Add environment variables
      HTTPS_PROXY: "${HTTPS_PROXY}"
      NO_PROXY: "${NO_PROXY}"


  mongo:                              # Mongo database for persisting data
    image: mongo                      # The Docker image to use for this service
    container_name: cloudharveststack-mongo  # The name of the container
    restart: always                   # Specifies the restart policy
    ports:                            # Maps the port inside the Docker container to the host
      - "27017:27017"
    command: >                        # The command to run inside the container 
      /bin/bash -c "
        docker-entrypoint.sh --bind_ip_all --logappend
      "
    networks:                         # Specifies the networks the container should connect to
      - CloudHarvestStackNetwork
    environment:                      # Add environment variables
      MONGO_INITDB_ROOT_USERNAME: "${MONGO_INITDB_ROOT_USERNAME:-admin}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGO_INITDB_ROOT_PASSWORD:-default-harvest-password}"
      HTTPS_PROXY: "${HTTPS_PROXY}"
      NO_PROXY: "${NO_PROXY}"
    volumes:
      - ./app/mongo/data:/data/db
      - ./app/mongo/logs:/var/log/mongodb

  mongo-seed:                         # Seeds the Mongo database with user configuration data
    image: mongo
    depends_on:                       # The services that this service depends on
      - mongo
    volumes:                          # Paths that should be mounted into the container
      - ./app/mongo-seed:/app
    networks:                         # Specifies the networks the container should connect to
      - CloudHarvestStackNetwork
    command: >
      /bin/bash -c '
      sleep 10
      && mongosh cloudharveststack-mongo/harvest
      --username ${MONGO_INITDB_ROOT_USERNAME:-admin}
      --password ${MONGO_INITDB_ROOT_PASSWORD:-default-harvest-password}
      --authenticationDatabase admin
      /app/mongo-seed.js'

  harvest-nodes:
    image: redis:latest
    container_name: cloudharveststack-redis-nodes
    restart: always
    ports:
      - "6380:6379"
    networks:
      - CloudHarvestStackNetwork
    environment:
      REDIS_PASSWORD: "${REDIS_PASSWORD:-default-harvest-password}"
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:-default-harvest-password}", "--maxmemory", "4gb"]

  harvest-tokens:
    image: redis:latest
    container_name: cloudharveststack-redis-tokens
    restart: always
    ports:
      - "6381:6379"
    networks:
      - CloudHarvestStackNetwork
    environment:
      REDIS_PASSWORD: "${REDIS_PASSWORD:-default-harvest-password}"
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:-default-harvest-password}", "--maxmemory", "4gb"]

  haproxy-tasks:
    image: haproxy:latest
    depends_on:
      - redis-tasks-node
    container_name: cloudharveststack-haproxy-tasks
    ports:
      - "6379:6379"
    volumes:
      - ./app/redis-tasks/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
    networks:
      - CloudHarvestStackNetwork
      - CloudHarvestTaskNodeNetwork

  redis-tasks-node:
    image: redis:latest
    restart: always
    deploy:
      replicas: ${TASK_NODES:-6}  # Number of task nodes to run
    networks:
      - CloudHarvestTaskNodeNetwork
    volumes:
      - ./app/redis-tasks/redis.conf:/usr/local/etc/redis/redis.conf
    command: ["redis-server", "/usr/local/etc/redis/redis.conf", "--requirepass", "${REDIS_PASSWORD:-default-harvest-password}"]
    environment:
      REDIS_PASSWORD: "${REDIS_PASSWORD:-default-harvest-password}"

  redis-tasks-cluster-setup:
    image: redis:latest
    depends_on:
      - redis-tasks-node
    networks:
      - CloudHarvestTaskNodeNetwork
    volumes:
      - ./app/redis-tasks/:/src/
    entrypoint: > 
      /bin/bash -c 'bash /src/add-nodes.sh'
    environment:
      REDIS_PASSWORD: "${REDIS_PASSWORD:-default-harvest-password}"
      TASK_NODES: "${TASK_NODES:-6}"

networks:
  CloudHarvestStackNetwork:
    driver: bridge
  CloudHarvestTaskNodeNetwork:
    driver: bridge
